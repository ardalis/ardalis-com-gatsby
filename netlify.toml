[build]
  publish = "public"
  command = "npm run build"
  functions = "lambda"

[build.environment]
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"

# Hugo branch configurations - use base directory to avoid npm install
[context."hugo-beta"]
  base = "beta"
  command = "hugo --minify -b $DEPLOY_PRIME_URL"
  publish = "public"
  
[context."hugo-beta".environment]
  HUGO_VERSION = "0.150.1"

# Branch deploys for any Hugo branch
[context.branch-deploy]
  command = """
    if [[ "$BRANCH" == *"hugo"* && -d "beta" ]]; then
      echo "Hugo branch detected, installing Hugo and building from beta folder"
      # Install Hugo if not present
      if ! command -v hugo &> /dev/null; then
        echo "Installing Hugo $HUGO_VERSION"
        cd /tmp
        wget -O hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        tar -xzf hugo.tar.gz
        chmod +x hugo
        sudo mv hugo /usr/local/bin/
        cd $OLDPWD
      fi
      echo "Hugo version: $(hugo version)"
      cd beta
      hugo --minify -b $DEPLOY_PRIME_URL
      cd ..
      mkdir -p public
      if [[ -d "beta/public" ]]; then
        cp -r beta/public/* public/ 2>/dev/null && echo "Hugo files copied to public/"
      else
        echo "ERROR: Hugo build failed - no public directory"
        exit 1
      fi
    else
      echo "Regular branch, building with Gatsby"
      npm run build
    fi
  """
  publish = "public"
  
[context.branch-deploy.environment]
  HUGO_VERSION = "0.150.1"
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"

# Deploy previews - optimized for Hugo branches
[context.deploy-preview]
  command = """
    if [[ "$BRANCH" == *"hugo"* && -d "beta" ]]; then
      echo "Hugo PR detected, installing Hugo and building from beta folder"
      # Install Hugo if not present
      if ! command -v hugo &> /dev/null; then
        echo "Installing Hugo $HUGO_VERSION"
        cd /tmp
        wget -O hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        tar -xzf hugo.tar.gz
        chmod +x hugo
        sudo mv hugo /usr/local/bin/
        cd $OLDPWD
      fi
      echo "Hugo version: $(hugo version)"
      cd beta
      hugo --minify -b $DEPLOY_PRIME_URL
      cd ..
      mkdir -p public
      if [[ -d "beta/public" ]]; then
        cp -r beta/public/* public/ 2>/dev/null && echo "Hugo files copied to public/"
      else
        echo "ERROR: Hugo build failed - no public directory"
        exit 1
      fi
    else
      echo "Gatsby PR, building normally"
      npm run build
    fi
  """
  publish = "public"

[context.deploy-preview.environment]
  HUGO_VERSION = "0.150.1"
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"

# Production remains Gatsby
[context.production]
  command = "npm run build"
  publish = "public"
  functions = "lambda"

[[plugins]]
package = "netlify-plugin-gatsby-cache"
