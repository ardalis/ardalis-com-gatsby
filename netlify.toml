[build]
  publish = "public"
  command = "npm run build"
  functions = "lambda"

[build.environment]
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"

# Hugo branch configurations - use base directory to avoid npm install
[context."hugo-beta"]
  base = "beta"
  command = "hugo --minify -b $DEPLOY_PRIME_URL"
  publish = "public"
  
[context."hugo-beta".environment]
  HUGO_VERSION = "0.150.1"

# Branch deploys for any Hugo branch
[context.branch-deploy]
  command = """
    if [[ "$BRANCH" == *"hugo"* && -d "beta" ]]; then
      echo "Hugo branch detected, building from beta folder"
      cd beta
      hugo --minify -b $DEPLOY_PRIME_URL
      cd ..
      mkdir -p public
      cp -r beta/public/* public/ 2>/dev/null || echo "No files to copy"
    else
      echo "Regular branch, building with Gatsby"
      npm run build
    fi
  """
  publish = "public"
  
[context.branch-deploy.environment]
  HUGO_VERSION = "0.150.1"
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"

# Deploy previews - optimized for Hugo branches
[context.deploy-preview]
  command = """
    if [[ "$BRANCH" == *"hugo"* && -d "beta" ]]; then
      echo "Hugo PR detected, building from beta folder"
      cd beta
      hugo --minify -b $DEPLOY_PRIME_URL
      cd ..
      mkdir -p public
      cp -r beta/public/* public/ 2>/dev/null || echo "No files to copy"
    else
      echo "Gatsby PR, building normally"
      npm run build
    fi
  """
  publish = "public"

[context.deploy-preview.environment]
  HUGO_VERSION = "0.150.1"
  NODE_VERSION = "18"
  NPM_FLAGS = "--legacy-peer-deps"

# Production remains Gatsby
[context.production]
  command = "npm run build"
  publish = "public"
  functions = "lambda"

[[plugins]]
package = "netlify-plugin-gatsby-cache"
